<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
		<title>
			{% block title %}ClubCine
			{% endblock %}
		</title>

		<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>ðŸŽ¬</text></svg>">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

		<style>
			body {
				display: flex;
				flex-direction: column;
				min-height: 100vh;
			}
			main {
				flex: 1;
			}
		</style>

		<link rel="stylesheet" href="{{ asset('styles/app.css') }}">
		{% block stylesheets %}{% endblock %}
		{% block javascripts %}
			{% block importmap %}
				{{ importmap('app') }}
			{% endblock %}
		{% endblock %}
	</head>
	<body>
		{# Usamos una variable global segura para el Navbar #}
		{# data-turbo="false" impide que Turbo reemplace el navbar #}
		<div data-turbo="false">
			{% include 'components/_navbar.html.twig' with {'groups': groups|default(null)} %}
		</div>

		<main>
			<div class="container mt-3">
				<div id="flash-container">
					{% for label, messages in app.flashes %}
						{% for message in messages %}
							<div class="alert alert-{{ label == 'error' or label == 'danger' ? 'danger' : 'success' }} alert-dismissible fade show shadow-sm" role="alert">
								{{ message }}
								<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
							</div>
						{% endfor %}
					{% endfor %}
				</div>
			</div>
			{% block body %}{% endblock %}
		</main>

		{# MODALES (Solo se renderizan si el usuario estÃ¡ logueado) #}
		{% if app.user %}
			<div class="modal fade" id="createGroupModal" tabindex="-1" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content border-0 shadow-lg">
						<div class="modal-header bg-primary text-white">
							<h5 class="modal-title">ðŸŽ¬ Fundar mi Club de Cine</h5>
							<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body p-4">
							{{ render(controller('App\\Module\\Group\\Controller\\GroupController::new')) }}
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade" id="infoFutureFeatureModal" tabindex="-1" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content border-0 shadow">
						<div class="modal-header bg-info text-white">
							<h5 class="modal-title">PrÃ³ximamente</h5>
							<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body p-4 text-center">
							<i class="bi bi-rocket-takeoff text-info fs-1"></i>
							<h5 class="mt-3 fw-bold">Â¡Un club no es suficiente!</h5>
							<p class="text-muted small">Estamos trabajando para que pronto puedas gestionar mÃºltiples clubes.</p>
						</div>
					</div>
				</div>
			</div>
		{% endif %}
		<script defer src="/_vercel/insights/script.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			function initializeBootstrap() {
				// Limpiar y reinicializar dropdowns
				document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(el => {
					const instance = bootstrap.Dropdown.getInstance(el);
					if (instance) {
						instance.dispose();
					}
					bootstrap.Dropdown.getOrCreateInstance(el);
				});
			}

			// Antes de que Turbo reemplace el DOM, destruir instancias
			document.addEventListener('turbo:before-render', () => {
				document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(el => {
					const instance = bootstrap.Dropdown.getInstance(el);
					if (instance) {
						instance.dispose();
					}
				});
			});

			// DespuÃ©s de que Turbo cargue, reinicializar
			document.addEventListener('turbo:load', initializeBootstrap);

			// Inicializar en la carga inicial
			document.addEventListener('DOMContentLoaded', initializeBootstrap);
		</script>
	</body>
</html>
