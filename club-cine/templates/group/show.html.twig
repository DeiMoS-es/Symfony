{# templates/group/show.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}ðŸŽ¬
	{{ group.name }}
{% endblock %}

{% block body %}
	<div class="container mt-4 pb-5">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h1 class="mb-0">ðŸŽ¬
				{{ group.name }}</h1>
			<a href="{{ path('user_dashboard') }}" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
				<i class="bi bi-arrow-left me-1"></i>
				Volver
			</a>
		</div>

		<ul class="nav nav-tabs border-bottom-0" id="groupTab" role="tablist">
			<li class="nav-item">
				<button class="nav-link active" id="cartelera-tab" data-bs-toggle="tab" data-bs-target="#cartelera" type="button" role="tab">
					<i class="bi bi-film me-2"></i>Cartelera
				</button>
			</li>
			<li class="nav-item">
				<button class="nav-link" id="miembros-tab" data-bs-toggle="tab" data-bs-target="#miembros" type="button" role="tab">
					<i class="bi bi-people me-2"></i>Miembros
				</button>
			</li>
			<li class="nav-item">
				<button class="nav-link" id="ajustes-tab" data-bs-toggle="tab" data-bs-target="#ajustes" type="button" role="tab">
					<i class="bi bi-gear me-2"></i>Ajustes
				</button>
			</li>
		</ul>

		<div
			class="tab-content bg-white p-4 shadow-sm rounded-bottom border" id="groupTabContent">

			{# PESTAÃ‘A CARTELERA #}
			<div class="tab-pane fade show active" id="cartelera" role="tabpanel">
				<div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4">
					{% for rec in recommendations %}
						<div class="col">
							<div
								class="card h-100 border-0 shadow-sm hover-shadow transition-all position-relative">

								{# Badge de Nota Media (Solo si estÃ¡ cerrada) #}
								{% if rec.status == 'CLOSED' %}
									<div class="position-absolute top-0 start-0 m-2 z-3">
										<span class="badge bg-primary fs-6 shadow-sm border border-white">
											<i class="bi bi-star-fill text-warning me-1"></i>
											{{ rec.averageScore|number_format(1) }}
										</span>
									</div>
								{% endif %}

								<div class="position-relative overflow-hidden rounded-3">
									{% if rec.movie.posterPath %}
										<img src="https://image.tmdb.org/t/p/w500{{ rec.movie.posterPath }}" class="img-fluid w-100 {{ rec.status == 'CLOSED' ? 'grayscale' : '' }}" alt="{{ rec.movie.title }}" style="aspect-ratio: 2/3; object-fit: cover;">
									{% else %}
										<div class="bg-secondary d-flex align-items-center justify-content-center text-white" style="aspect-ratio: 2/3;">
											<i class="bi bi-camera-video fs-1 opacity-25"></i>
										</div>
									{% endif %}

									<div class="position-absolute bottom-0 start-0 end-0 p-2 bg-dark bg-opacity-75 backdrop-blur">
										{% if rec.status == 'OPEN' %}
											{# BOTÃ“N PARA VOTAR (Abierto) #}
											{% if rec.status == 'OPEN' %}
												{# Comprobamos si el usuario ya ha votado #}
												{% set hasVoted = false %}
												{% for review in rec.reviews %}
													{% if review.user.id == app.user.id %}
														{% set hasVoted = true %}
													{% endif %}
												{% endfor %}

												{% if hasVoted %}
													{# BOTÃ“N DESACTIVADO O ESTILO "YA VOTADO" #}
													<button class="btn btn-secondary btn-sm w-100 fw-bold rounded-pill opacity-75" disabled>
														<i class="bi bi-check-all me-1"></i>
														YA VOTADO
													</button>
												{% else %}
													{# BOTÃ“N ACTIVO PARA VOTAR #}
													<a href="{{ path('app_review_new', {id: rec.id}) }}" class="btn btn-success btn-sm w-100 fw-bold rounded-pill">
														<i class="bi bi-pencil-square me-1"></i>
														VOTAR
													</a>
												{% endif %}
											{% endif %}
										{% else %}
											{# INFO DE CIERRE (Cerrado) #}
											<div class="text-white text-center small py-1">
												<i class="bi bi-check2-circle me-1"></i>
												Finalizado
											</div>
										{% endif %}
									</div>
								</div>

								<div class="card-body px-0 pt-2 pb-0">
									<h6 class="fw-bold mb-1 text-truncate" title="{{ rec.movie.title }}">
										{{ rec.movie.title }}
									</h6>
									<div class="d-flex align-items-center justify-content-between">
										<div class="d-flex align-items-center gap-1 overflow-hidden">
											<i class="bi bi-person-circle text-muted" style="font-size: 0.7rem;"></i>
											<small class="text-muted text-truncate" style="font-size: 0.75rem;">
												{{ rec.recommendedBy.name|default(rec.recommendedBy.email|split('@')[0]) }}
											</small>
										</div>

										{% if rec.status == 'CLOSED' %}
											<small class="text-primary fw-bold" style="font-size: 0.7rem;">
												{{ rec.totalVotes }}
												votos
											</small>
										{% endif %}
									</div>
								</div>
							</div>
						</div>
						{% else %}
						{# ... (el bloque de "No hay pelÃ­culas" que ya tienes) ... #}
					{% endfor %}
				</div>
			</div>

			{# PESTAÃ‘A MIEMBROS #}
			<div
				class="tab-pane fade" id="miembros" role="tabpanel">

				{# Banner de invitaciÃ³n solo para el OWNER #}
				{% if app.user.id == group.owner.id %}
					<div class="card border-0 bg-primary-subtle mb-4 shadow-sm">
						<div class="card-body p-3">
							<div class="d-flex align-items-center justify-content-between">
								<div class="d-flex align-items-center gap-3">
									<div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
										<i class="bi bi-megaphone-fill"></i>
									</div>
									<div>
										<h6 class="mb-0 fw-bold text-primary-emphasis">Â¡Crece tu comunidad!</h6>
										<p class="small mb-0 d-none d-md-block text-primary-emphasis opacity-75">
											Invita a otros amigos para compartir recomendaciones.
										</p>
									</div>
								</div>

								{# BOTÃ“N QUE ABRE EL MODAL #}
								<button class="btn btn-primary rounded-pill d-flex align-items-center gap-2 px-3 px-md-4" data-bs-toggle="modal" data-bs-target="#addMemberModal">
									<i class="bi bi-person-plus-fill"></i>
									<span class="d-none d-md-inline fw-bold">AÃ±adir miembro</span>
								</button>
							</div>
						</div>
					</div>

					{# MODAL DE INVITACIÃ“N (Dentro del IF por seguridad) #}
					<div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered">
							<div class="modal-content border-0 shadow">
								<div class="modal-header border-0 pb-0">
									<h5 class="modal-title fw-bold" id="addMemberModalLabel">
										<i class="bi bi-person-plus text-primary me-2"></i>Invitar al club
									</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
								</div>

								{{ form_start(invitationForm, {'action': path('app_group_invite', {id: group.id}), 'method': 'POST'}) }}
								<div class="modal-body py-4">
									<p class="text-muted small mb-4">
										EnvÃ­a una invitaciÃ³n por correo electrÃ³nico. Si ya es usuario, se unirÃ¡ automÃ¡ticamente al aceptar.
									</p>

									<div class="mb-3">
										<label class="form-label fw-semibold small text-uppercase">Correo electrÃ³nico</label>
										{{ form_widget(invitationForm.email, {
                                            'attr': {
                                                'class': 'form-control form-control-lg rounded-3',
                                                'placeholder': 'ejemplo@correo.com'
                                            }
                                        }) }}
										<div class="text-danger small mt-1">
											{{ form_errors(invitationForm.email) }}
										</div>
									</div>
								</div>

								<div class="modal-footer border-0 pt-0">
									<button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
									<button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm">
										Enviar invitaciÃ³n
									</button>
								</div>
								{{ form_end(invitationForm) }}
							</div>
						</div>
					</div>
				{% endif %}

				<div class="d-flex align-items-center gap-2 mb-3 px-1">
					<i class="bi bi-people-fill text-secondary"></i>
					<span class="fw-bold small text-uppercase tracking-wider text-secondary">
						Miembros del club â€”
						{{ group.members|length }}
					</span>
				</div>

				<div class="list-group list-group-flush shadow-sm rounded-3 border overflow-hidden">
					{% for groupMember in group.members %}
						<div class="list-group-item d-flex align-items-center justify-content-between py-3">
							<div class="d-flex align-items-center gap-3 overflow-hidden">
								<i class="bi bi-person-circle fs-3 text-secondary-subtle"></i>
								<div class="text-truncate">
									<span class="fw-bold d-block text-truncate" style="font-size: 0.9rem;">
										{{ groupMember.user.name|default(groupMember.user.email) }}
									</span>
									{% if groupMember.role == 'OWNER' %}
										<span class="badge bg-warning-subtle text-warning-emphasis p-1 px-2" style="font-size: 0.65rem;">
											<i class="bi bi-star-fill me-1"></i>FUNDADOR
										</span>
									{% endif %}
								</div>
							</div>
							<div class="d-none d-sm-block text-end me-3">
								<small class="text-muted small d-block">{{ groupMember.user.email }}</small>
							</div>
						</div>
					{% endfor %}
				</div>
			</div>

			{# PESTAÃ‘A AJUSTES #}
			<div class="tab-pane fade" id="ajustes" role="tabpanel">
				<div class="row">
					<div class="col-md-6 border-end">
						<h6 class="fw-bold">InformaciÃ³n General</h6>
						<p class="small text-muted">{{ group.description|default('Sin descripciÃ³n.') }}</p>
						<button class="btn btn-sm btn-outline-primary rounded-pill">Editar Club</button>
					</div>
					<div class="col-md-6 ps-md-4">
						<h6 class="text-danger fw-bold">Zona de peligro</h6>
						<p class="small text-muted">Si abandonas el club, perderÃ¡s acceso a esta cartelera.</p>
						<button class="btn btn-sm btn-danger rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#leaveModal">
							Darse de baja del club
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	{# MODAL PARA ABANDONAR CLUB #}
	<div class="modal fade" id="leaveModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-sm">
			<div class="modal-content border-0 shadow">
				<div class="modal-header border-0">
					<h5 class="modal-title fw-bold">Â¿Abandonar club?</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body py-0">
					<p class="small text-muted">Â¿EstÃ¡s seguro de que quieres dejar
						<strong>{{ group.name }}</strong>?</p>
				</div>
				<div class="modal-footer border-0">
					<button type="button" class="btn btn-light btn-sm rounded-pill" data-bs-dismiss="modal">Cancelar</button>
					<button type="submit" class="btn btn-danger btn-sm rounded-pill px-3">Confirmar baja</button>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
